<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/index.css"/>
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/base.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/version.css">
    <link type="text/css" rel="stylesheet" href="__PUBLIC__/css/map.css">
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=coutX13A0Ps5YoiMbpVWsCCjsWBHDoQ7"></script>
    <title>叮叮驾校</title>
</head>
<body>
<div class="header">
    <div class="logo"></div>
    <div class="nav">
        <ul>
            <li><a href="{:url('index')}">首页</a></li>
            <li class="current"><a href="{:url('yard')}">场地分布</a></li>
            <li><a href="{:url('applynotice')}"> 报名须知</a></li>
            <li><a href="{:url('aboutme')}">关于我们</a></li>
            <li><a href="{:url('joinme')}">加入我们</a></li>
        </ul>
    </div>
    <div class="rj"></div>
    <div class="phone">400-188-3382</div>
</div>
<div class="y_map"id="map"></div>
<div class="ed-map">
    <div class="srch">
        <input id="suggestId" name="" type="text" class="txt" placeholder="输入你想学车的地点">
        <button class="butn" id="locateInMap">搜索</button>
    </div>
    <div class="sel-map mt15" id="trainplaceList">
        <div class="smti">
            <ul class="clearfix">
                <li><div class="ct"><span class="selectPlace">城市：成都市</span><i class="ico ico13"></i></div></li>
                <li><div class="at"><span class="selectPlace" id="selectedDistrict">区域：全部</span><i class="ico ico13"></i></div></li>
            </ul>
        </div>
        <div class="smci">
            <ul id="trainplaceContainer" style="overflow:auto;">
                <!--<li>-->
                <!--<i class="ico ico15">1</i>-->
                <!--<p class="sti">西南机动车驾驶员培训中心</p>-->
                <!--<p>重庆市渝北区金渝大道99号汽博中心汽... </p>-->
                <!--<p>电话：13883349681</p>-->
                <!--</li>-->
            </ul>
            <div id="selectPanel" style="width: 100%; height: 300px; display: none;">
                <div style="float: left; width: 50%;">
                    <ul id="province"></ul>
                </div>
                <div style="float: right; overflow: auto; height: 300px; width: 50%;">
                    <ul id="district"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="__PUBLIC__/js/jquery-1.7.2.min.js"></script>
<script src="__PUBLIC__/js/baiduMap.js"></script>
<script src="__PUBLIC__/js/provinceDic.js"></script>
<script src="__PUBLIC__/js/utils.js"></script>
<!--百度地图-->
<script type="text/javascript">
    //创建和初始化地图函数：
    function initMap(){
        createMap();//创建地图
        setMapEvent();//设置地图事件
        addMapControl();//向地图添加控件
        addMapOverlay();//向地图添加覆盖物
        for (var i = 0; i < markerArr.length; i++) {
            var p0 = markerArr[i].point.split(",")[0];
            var p1 = markerArr[i].point.split(",")[1];
            var maker = addMarker(new window.BMap.Point(p0, p1), i);
            addInfoWindow(maker, markerArr[i], i);
        }
    }
    var markerArr = [
        { title: "名称：四川大学", point: "104.088119,30.637545", address: "四川省成都市武侯区一环路南一段24号 ", tel: "12306" },
        { title: "名称：成都理工大学", point: "104.15048,30.680737", address: "四川省成都市成华区三环以内二仙桥东三路1号  ", tel: "18500000000" },
        { title: "名称：成都师范学院", point: "103.835572,30.682091", address: "四川省成都市温江区海科路东段99号 ", tel: "18500000000" },
        { title: "名称：四川师范大学", point: "104.129339,30.615519", address: "四川省成都市锦江区静安路5号 ", tel: "18500000000" }
    ];
    function createMap(){
        map = new BMap.Map("map");
        map.centerAndZoom(new BMap.Point(104.084009,30.683551),12);
        for (var i = 0; i < markerArr.length; i++) {
            var p0 = markerArr[i].point.split(",")[0];
            var p1 = markerArr[i].point.split(",")[1];
            var maker = addMarker(new window.BMap.Point(p0, p1), i);
            addInfoWindow(maker, markerArr[i], i);
        }
    }
    function setMapEvent(){
        map.enableScrollWheelZoom();
        map.enableKeyboard();
        map.enableDragging();
        map.enableDoubleClickZoom()
    }
    function addClickHandler(target,window){
        target.addEventListener("click",function(){
            target.openInfoWindow(window);
        });
    }
    function addMapOverlay(){

    }
    //向地图添加控件
    function addMapControl(){
        var scaleControl = new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});
        scaleControl.setUnit(BMAP_UNIT_IMPERIAL);
        map.addControl(scaleControl);
        var navControl = new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_LARGE});
        map.addControl(navControl);
        var overviewControl = new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:false});
        map.addControl(overviewControl);
    }
    function addMarker(point, index) {
        var myIcon = new BMap.Icon("http://api.map.baidu.com/img/markers.png",
                new BMap.Size(23, 25), {
                    offset: new BMap.Size(10, 25),
                    imageOffset: new BMap.Size(0, 0 - index * 25)
                });
        var marker = new BMap.Marker(point, { icon: myIcon });
        map.addOverlay(marker);
        return marker;
    }

    // 添加信息窗口
    function addInfoWindow(marker, poi) {
        //pop弹窗标题
        var title = '<div style="font-weight:bold;color:#CE5521;font-size:14px">' + poi.title + '</div>';
        //pop弹窗信息
        var html = [];
        html.push('<table cellspacing="0" style="table-layout:fixed;width:100%;font:12px arial,simsun,sans-serif"><tbody>');
        html.push('<tr>');
        html.push('<td style="vertical-align:top;line-height:16px;width:38px;white-space:nowrap;word-break:keep-all">地址:</td>');
        html.push('<td style="vertical-align:top;line-height:16px">' + poi.address + ' </td>');
        html.push('</tr>');
        html.push('</tbody></table>');
        var infoWindow = new BMap.InfoWindow(html.join(""), { title: title, width: 200 });

        var openInfoWinFun = function () {
            marker.openInfoWindow(infoWindow);
        };
        marker.addEventListener("mouseover", openInfoWinFun);
        return openInfoWinFun;
    }
    var map;
    initMap();
</script>
<script>
    $(document).ready(function () {
        $('#mapmap').css('width', '100%');
        $('#map').css('height', document.documentElement.clientHeight);
        window.onresize=function(){
            $('#map').css('height', document.documentElement.clientHeight);
        };

        //显示区县选择框
        var clickIndex = -1;
        provinceList.forEach(function (pro) {
            $('#province').append('<li>' + pro + '</li>');
            if (Array.isArray(provinceDic[pro])) {
                provinceDic[pro].forEach(function (district, index) {
                    $('#district').append('<li style="padding: 10px;" id=' + ("district" + index) + '>' + district + '</li>');
                    $('#district' + index).click(function () {
                        $('#selectedDistrict').html('区域：' + district);
                        $('#trainplaceContainer').show();
                        $('#selectPanel').hide();
                        if (clickIndex > -1) {
                            $('#district' + clickIndex).removeAttr("style");
                        }
                        $('#district' + index).css("border-bottom", "2px solid #4c98ff");
                        $('#district' + index).css("list-style-type", "none");
                        clickIndex = index;
                        getTrainplaceByAddress('四川省', '成都市', district === '全部' ? null : district, afterGetTrainplace);
                    })
                });
            } else {
                alert('地区字典表获取失败');
            }
        });

        $('.selectPlace').click(function () {
            $('#trainplaceContainer').hide();
            $('#selectPanel').show();
        })

//        getCurrentLocatin();

        //获取场地信息
        getTrainplaceByAddress('四川省', '成都市', null, afterGetTrainplace);

        //场地信息获取成功执行的方法
        function afterGetTrainplace(data) {
            //添加到显示栏中
            var trainplaceList = data.data.data;
            if (Array.isArray(trainplaceList)) {
                var trainplaceNum = trainplaceList.length;
                var height = trainplaceNum * 100;
                if (height > 600) {
                    height = 600;
                }
                $('#trainplaceContainer').empty();
                $('#trainplaceContainer').css('height', height + 'px');
                trainplaceList.forEach(function (trainplace, index) {
                    $('#trainplaceContainer').append('<li>' +
                            '<i class="ico ico15">' + (parseInt(index) + 1) + '</i>' +
                            '<p class="sti">' + trainplace.name + '</p>' +
                            '<p>' + trainplace.address +  '</p>' +
//                        '<p>' + '电话：' + trainplace.contact_person_phone + '</p>' +
                            '</li>');
                })
            } else {
                alert('训练场地获取失败，请稍候再试');
            }
        }

        //调用输入完成提示功能
        autoComplete();

        //点击搜索，地图进行定位
        $('#locateInMap').click(function () {
            getCoordsByAddress('成都市', $('#suggestId').val());
        });

        //实时监控输入值变化
        $('#suggestId').bind('input change', function () {
            // 要执行的代码
            if ($('#suggestId').val().length > 0) {
                $('#trainplaceList').hide();
            } else {
                $('#trainplaceList').show();
            }
        })
    });
</script>
</html>